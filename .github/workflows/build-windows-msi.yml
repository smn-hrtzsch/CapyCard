name: Build Windows Installer

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-msi:
    runs-on: windows-latest

    env:
      Configuration: Release
      RuntimeIdentifier: win-x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install WiX Toolset
        run: choco install wixtoolset --no-progress --yes

      - name: Calculate version
        id: version
        shell: pwsh
        working-directory: FlashcardMobile/FlashcardMobile.Desktop
        run: |
          # If version is passed from caller workflow, use it
          $inputVersion = "${{ inputs.version }}"

          if ($inputVersion) {
             $versionParts = $inputVersion.Split('.')
             $versionMajor = $versionParts[0]
             $versionMinor = $versionParts[1]
             $versionBuild = $versionParts[2]
             $versionRevision = 0
             $msiVersion = "$versionMajor.$versionMinor.$versionBuild"
             $fullVersion = "$msiVersion"
          } else {
             # Fallback to project file if no input
             $versionMajor = [int](dotnet msbuild FlashcardMobile.Desktop.csproj -nologo -getProperty:VersionMajor)
             if (-not $versionMajor) { $versionMajor = 1 }
             $versionMinor = [int](dotnet msbuild FlashcardMobile.Desktop.csproj -nologo -getProperty:VersionMinor)
             if (-not $versionMinor) { $versionMinor = 0 }
             
             $utcNow = [DateTime]::UtcNow
             $versionBuild = (($utcNow.Year - 2000) * 400) + $utcNow.DayOfYear
             $versionRevision = $utcNow.ToString('HHmm')
             $msiVersion = "$versionMajor.$versionMinor.$versionBuild"
             $fullVersion = "$msiVersion.$versionRevision"
          }
          
          "versionMajor=$versionMajor" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "versionMinor=$versionMinor" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "versionBuild=$versionBuild" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "versionRevision=$versionRevision" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "msiVersion=$msiVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "fullVersion=$fullVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append      - name: Publish Windows build
        run: dotnet publish FlashcardMobile/FlashcardMobile.Desktop/FlashcardMobile.Desktop.csproj -c $env:Configuration -r $env:RuntimeIdentifier --self-contained true /p:PublishSingleFile=true -p:VersionMajor=${{ steps.version.outputs.versionMajor }} -p:VersionMinor=${{ steps.version.outputs.versionMinor }} -p:VersionBuild=${{ steps.version.outputs.versionBuild }} -p:VersionRevision=${{ steps.version.outputs.versionRevision }}

      - name: Build MSI installer
        working-directory: FlashcardMobile/Installer
        run: |
          dotnet build FlashcardMobile.Installer.wixproj -c $env:Configuration -p:VersionMajor=${{ steps.version.outputs.versionMajor }} -p:VersionMinor=${{ steps.version.outputs.versionMinor }} -p:VersionBuild=${{ steps.version.outputs.versionBuild }} -p:VersionRevision=${{ steps.version.outputs.versionRevision }} -p:ProductVersion=${{ steps.version.outputs.msiVersion }}

      - name: Archive MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi-${{ steps.version.outputs.fullVersion }}
          path: FlashcardMobile/Installer/bin/${{ env.Configuration }}/*.msi

      - name: Clean previous MSI releases
        if: github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          $releaseDir = "Release"
          if (Test-Path $releaseDir) {
            Get-ChildItem $releaseDir -Filter "Alinas-Karteikarten-*.msi" | Remove-Item -Force
          }

      - name: Copy MSI into repo Release folder
        if: github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          $msi = Get-ChildItem "FlashcardMobile/Installer/bin/${{ env.Configuration }}" -Filter *.msi | Select-Object -First 1
          if (-not $msi) { throw "No MSI output found" }
          $releaseDir = "Release"
          New-Item -ItemType Directory -Path $releaseDir -Force | Out-Null
          $destination = Join-Path $releaseDir "Alinas-Karteikarten-${{ steps.version.outputs.fullVersion }}.msi"
          Copy-Item $msi.FullName $destination -Force

      - name: Commit release artifact
        if: github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          $branch = "${{ github.ref_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin $branch
          git add Release
          if (git diff --cached --quiet) {
            Write-Host "No release changes to commit."
            exit 0
          }
          git commit -m "Add Windows MSI release ${{ steps.version.outputs.fullVersion }} [skip ci]"
          git push origin HEAD:$branch
