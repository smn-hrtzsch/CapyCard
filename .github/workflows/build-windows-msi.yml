name: Build Windows Installer

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-msi:
    runs-on: windows-latest

    env:
      Configuration: Release
      RuntimeIdentifier: win-x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install WiX Toolset
        run: choco install wixtoolset --no-progress --yes

      - name: Calculate version
        id: version
        shell: pwsh
        working-directory: CapyCard/CapyCard.Desktop
        run: |
          # If version is passed from caller workflow, use it
          $inputVersion = "${{ inputs.version }}"

          if ($inputVersion) {
             $versionParts = $inputVersion.Split('.')
             $versionMajor = $versionParts[0]
             $versionMinor = $versionParts[1]
             $versionBuild = $versionParts[2]
             $versionRevision = 0
             $msiVersion = "$versionMajor.$versionMinor.$versionBuild"
             $fullVersion = "$msiVersion"
          } else {
             # Fallback to project file if no input
             $currentVersion = dotnet msbuild CapyCard.Desktop.csproj -nologo -getProperty:Version
             if (-not $currentVersion) { $currentVersion = "1.0.0" }
             
             $vParts = $currentVersion.Split('.')
             $versionMajor = $vParts[0]
             $versionMinor = $vParts[1]
             
             $utcNow = [DateTime]::UtcNow
             # Convert to German Time (CET/CEST)
             $tz = [TimeZoneInfo]::FindSystemTimeZoneById("W. Europe Standard Time")
             $germanTime = [TimeZoneInfo]::ConvertTimeFromUtc($utcNow, $tz)
             
             $versionBuild = (($germanTime.Year - 2000) * 400) + $germanTime.DayOfYear
             $versionRevision = $germanTime.ToString('HHmm')
             $msiVersion = "$versionMajor.$versionMinor.$versionBuild"
             
             # Readable filename for test builds
             $dateStr = $germanTime.ToString('yyyy-MM-dd_HH-mm')
             $fullVersion = "$versionMajor.$versionMinor-dev-$dateStr"
          }
          
          "versionMajor=$versionMajor" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "versionMinor=$versionMinor" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "versionBuild=$versionBuild" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "versionRevision=$versionRevision" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "msiVersion=$msiVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "fullVersion=$fullVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Publish Windows build
        run: dotnet publish CapyCard/CapyCard.Desktop/CapyCard.Desktop.csproj -c $env:Configuration -r $env:RuntimeIdentifier --self-contained true /p:PublishSingleFile=true -p:VersionMajor=${{ steps.version.outputs.versionMajor }} -p:VersionMinor=${{ steps.version.outputs.versionMinor }} -p:VersionBuild=${{ steps.version.outputs.versionBuild }} -p:VersionRevision=${{ steps.version.outputs.versionRevision }}

      - name: Build MSI installer
        working-directory: CapyCard/Installer
        run: |
          dotnet build CapyCard.Installer.wixproj -c $env:Configuration -p:VersionMajor=${{ steps.version.outputs.versionMajor }} -p:VersionMinor=${{ steps.version.outputs.versionMinor }} -p:VersionBuild=${{ steps.version.outputs.versionBuild }} -p:VersionRevision=${{ steps.version.outputs.versionRevision }} -p:ProductVersion=${{ steps.version.outputs.msiVersion }}

      - name: Rename MSI
        shell: pwsh
        run: |
          $msiPath = Get-ChildItem "CapyCard/Installer/bin/${{ env.Configuration }}/*.msi" | Select-Object -First 1
          $newName = "CapyCard-windows-${{ steps.version.outputs.fullVersion }}.msi"
          Rename-Item -Path $msiPath.FullName -NewName $newName

      - name: Archive MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: CapyCard/Installer/bin/${{ env.Configuration }}/*.msi
