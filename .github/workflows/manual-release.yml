name: Manual Release Build

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of release"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      release_title:
        description: "Release Title (optional)"
        required: false
        type: string
      version_override:
        description: "Existing version to reuse (optional, e.g. 2.6.0)"
        required: false
        type: string
      asset_build_mode:
        description: "Asset build mode"
        required: true
        default: "missing_only"
        type: choice
        options:
          - missing_only
          - rebuild_selected
          - rebuild_all
      rebuild_android:
        description: "Rebuild Android asset (used in rebuild_selected mode)"
        required: false
        default: false
        type: boolean
      rebuild_windows:
        description: "Rebuild Windows asset (used in rebuild_selected mode)"
        required: false
        default: false
        type: boolean
      rebuild_macos:
        description: "Rebuild macOS asset (used in rebuild_selected mode)"
        required: false
        default: false
        type: boolean

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump_version.outputs.new_version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump Version
        id: bump_version
        shell: pwsh
        run: |
          $propsPath = "CapyCard/Directory.Build.props"
          [xml]$xml = Get-Content $propsPath
          $version = [version]$xml.Project.PropertyGroup.Version

          $versionOverride = "${{ inputs.version_override }}"
          if ($versionOverride) {
              $newVersion = $versionOverride
              Write-Host "Using overridden version: $newVersion"
          }
          else {
              $major = $version.Major
              $minor = $version.Minor
              $build = $version.Build

              $type = "${{ inputs.release_type }}"

              if ($type -eq "major") {
                  $major++
                  $minor = 0
                  $build = 0
              }
              elseif ($type -eq "minor") {
                  $minor++
                  $build = 0
              }
              else {
                  $build++
              }

              $newVersion = "$major.$minor.$build"
          }
          $xml.Project.PropertyGroup.Version = $newVersion
          $xml.Save($propsPath)

          Write-Host "New Version: $newVersion"
          "new_version=$newVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Check if release tag already exists
        id: tag_check
        run: |
          if git rev-parse -q --verify "refs/tags/v${{ steps.bump_version.outputs.new_version }}" >/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release tag v${{ steps.bump_version.outputs.new_version }} already exists. Reusing existing tag."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Version Bump & Tag
        id: create_tag
        if: ${{ steps.tag_check.outputs.exists != 'true' }}
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add CapyCard/Directory.Build.props
          git commit -m "Bump version to ${{ steps.bump_version.outputs.new_version }}"
          git tag "v${{ steps.bump_version.outputs.new_version }}"
          git push
          git push origin "v${{ steps.bump_version.outputs.new_version }}"
          echo "tag_name=v${{ steps.bump_version.outputs.new_version }}" >> "$GITHUB_OUTPUT"

      - name: Create Draft Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "v${{ steps.bump_version.outputs.new_version }}" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            echo "Release v${{ steps.bump_version.outputs.new_version }} already exists. Skipping draft creation."
          else
            gh release create v${{ steps.bump_version.outputs.new_version }} \
              --title "${{ inputs.release_title != '' && inputs.release_title || format('Release v{0}', steps.bump_version.outputs.new_version) }}" \
              --draft \
              --notes "Automated release build for v${{ steps.bump_version.outputs.new_version }}"
          fi

  call-build-android:
    needs: [bump-version, check-release-assets]
    if: ${{ needs.check-release-assets.outputs.build_android == 'true' }}
    uses: ./.github/workflows/build-android-apk.yml
    with:
      version: ${{ needs.bump-version.outputs.new_version }}
    secrets: inherit
    permissions:
      contents: write

  call-build-windows:
    needs: [bump-version, check-release-assets]
    if: ${{ needs.check-release-assets.outputs.build_windows == 'true' }}
    uses: ./.github/workflows/build-windows-msi.yml
    with:
      version: ${{ needs.bump-version.outputs.new_version }}
    secrets: inherit
    permissions:
      contents: write

  call-build-macos:
    needs: [bump-version, check-release-assets]
    if: ${{ needs.check-release-assets.outputs.build_macos == 'true' }}
    uses: ./.github/workflows/build-macos-app.yml
    with:
      version: ${{ needs.bump-version.outputs.new_version }}
    secrets: inherit
    permissions:
      contents: write

  publish-release:
    needs:
      [bump-version, check-release-assets, call-build-android, call-build-windows, call-build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Publish Draft Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit v${{ needs.bump-version.outputs.new_version }} --draft=false --repo ${{ github.repository }}

  check-release-assets:
    needs: bump-version
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      build_android: ${{ steps.asset_check.outputs.build_android }}
      build_windows: ${{ steps.asset_check.outputs.build_windows }}
      build_macos: ${{ steps.asset_check.outputs.build_macos }}
    steps:
      - name: Check existing release assets
        id: asset_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          version="${{ needs.bump-version.outputs.new_version }}"
          tag="v${version}"
          mode="${{ inputs.asset_build_mode }}"

          android_asset="CapyCard-android-${version}.apk"
          windows_asset="CapyCard-windows-${version}.msi"
          macos_asset="CapyCard-macos-${version}.dmg"

          assets="$(gh release view "$tag" --repo "${{ github.repository }}" --json assets --jq '.assets[].name' 2>/dev/null || true)"

          has_android=false
          has_windows=false
          has_macos=false

          if echo "$assets" | grep -Fxq "$android_asset"; then has_android=true; fi
          if echo "$assets" | grep -Fxq "$windows_asset"; then has_windows=true; fi
          if echo "$assets" | grep -Fxq "$macos_asset"; then has_macos=true; fi

          build_android=false
          build_windows=false
          build_macos=false

          if [ "$mode" = "rebuild_all" ]; then
            build_android=true
            build_windows=true
            build_macos=true
          elif [ "$mode" = "rebuild_selected" ]; then
            if [ "${{ inputs.rebuild_android }}" = "true" ]; then build_android=true; fi
            if [ "${{ inputs.rebuild_windows }}" = "true" ]; then build_windows=true; fi
            if [ "${{ inputs.rebuild_macos }}" = "true" ]; then build_macos=true; fi
            if [ "$build_android" = false ] && [ "$build_windows" = false ] && [ "$build_macos" = false ]; then
              echo "Mode rebuild_selected requires at least one asset selection." >&2
              exit 1
            fi
          else
            build_android=$([ "$has_android" = true ] && echo false || echo true)
            build_windows=$([ "$has_windows" = true ] && echo false || echo true)
            build_macos=$([ "$has_macos" = true ] && echo false || echo true)
          fi

          echo "build_android=$build_android" >> "$GITHUB_OUTPUT"
          echo "build_windows=$build_windows" >> "$GITHUB_OUTPUT"
          echo "build_macos=$build_macos" >> "$GITHUB_OUTPUT"

          echo "Detected assets:"
          echo "- Android ($android_asset): $has_android"
          echo "- Windows ($windows_asset): $has_windows"
          echo "- macOS ($macos_asset): $has_macos"
          echo "Selection:"
          echo "- Mode: $mode"
          echo "- Rebuild Android: ${{ inputs.rebuild_android }}"
          echo "- Rebuild Windows: ${{ inputs.rebuild_windows }}"
          echo "- Rebuild macOS: ${{ inputs.rebuild_macos }}"
          echo "Build decision:"
          echo "- Android: $build_android"
          echo "- Windows: $build_windows"
          echo "- macOS: $build_macos"
