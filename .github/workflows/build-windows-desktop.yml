name: Build Windows Desktop App

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      Configuration: Release
      RuntimeIdentifier: win-x64
      ProjectSlug: "CapyCard"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Calculate version
        id: version
        shell: pwsh
        working-directory: FlashcardMobile/FlashcardMobile.Desktop
        run: |
          $versionMajor = [int](dotnet msbuild FlashcardMobile.Desktop.csproj -nologo -getProperty:VersionMajor)
          if (-not $versionMajor) { $versionMajor = 1 }
          $versionMinor = [int](dotnet msbuild FlashcardMobile.Desktop.csproj -nologo -getProperty:VersionMinor)
          if (-not $versionMinor) { $versionMinor = 0 }
          
          $utcNow = [DateTime]::UtcNow
          $versionBuild = (($utcNow.Year - 2000) * 400) + $utcNow.DayOfYear
          $versionRevision = $utcNow.ToString('HHmm')
          $semVersion = "$versionMajor.$versionMinor.$versionBuild"
          $fullVersion = "$semVersion.$versionRevision"
          "versionMajor=$versionMajor" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "versionMinor=$versionMinor" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "versionBuild=$versionBuild" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "versionRevision=$versionRevision" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "semVersion=$semVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "fullVersion=$fullVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Publish Windows build
        run: dotnet publish FlashcardMobile/FlashcardMobile.Desktop/FlashcardMobile.Desktop.csproj -c $env:Configuration -r $env:RuntimeIdentifier --self-contained true -p:PublishSingleFile=true -p:VersionMajor=${{ steps.version.outputs.versionMajor }} -p:VersionMinor=${{ steps.version.outputs.versionMinor }} -p:VersionBuild=${{ steps.version.outputs.versionBuild }} -p:VersionRevision=${{ steps.version.outputs.versionRevision }} -o published

      - name: Zip Release
        shell: pwsh
        run: |
          $zipName = "${{ env.ProjectSlug }}-windows-${{ steps.version.outputs.fullVersion }}.zip"
          Compress-Archive -Path published/* -DestinationPath $zipName
          "zipName=$zipName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        id: zip

      - name: Archive Release artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip-${{ steps.version.outputs.fullVersion }}
          path: ${{ steps.zip.outputs.zipName }}

      - name: Clean previous Windows releases
        if: github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          $releaseDir = "Release"
          if (Test-Path $releaseDir) {
            Get-ChildItem $releaseDir -Filter "${{ env.ProjectSlug }}-windows-*.zip" | Remove-Item -Force
            # Clean old ones too
            Get-ChildItem $releaseDir -Filter "Alinas-Karteikarten-*.msi" | Remove-Item -Force
          }

      - name: Copy Zip into repo Release folder
        if: github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          $zipName = "${{ steps.zip.outputs.zipName }}"
          $releaseDir = "Release"
          New-Item -ItemType Directory -Path $releaseDir -Force | Out-Null
          $destination = Join-Path $releaseDir $zipName
          Copy-Item $zipName $destination -Force

      - name: Commit release artifact
        if: github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          $branch = "${{ github.ref_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin $branch
          git add Release
          if (git diff --cached --quiet) {
            Write-Host "No release changes to commit."
            exit 0
          }
          git commit -m "Add Windows Desktop release ${{ steps.version.outputs.fullVersion }} [skip ci]"
          git push origin HEAD:$branch