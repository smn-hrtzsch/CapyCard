name: Build Android APK

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      Configuration: Release
      ProjectSlug: "CapyCard"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install Android workload
        run: dotnet workload install android

      # NEU: Keystore aus Secrets wiederherstellen
      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > FlashcardMobile/FlashcardMobile.Android/release.keystore

      - name: Calculate version
        id: version
        working-directory: FlashcardMobile/FlashcardMobile.Android
        run: |
          inputVersion="${{ inputs.version }}"

          if [ -n "$inputVersion" ]; then
             # Use provided version
             fullVersion="$inputVersion"
             # For versionCode, we use the run number to ensure it increases
             versionBuild=${{ github.run_number }}
             filenameVersion="$fullVersion"
          else
             # Fallback logic: Read version from project
             currentVersion=$(dotnet msbuild FlashcardMobile.Android.csproj -nologo -getProperty:Version)
             if [ -z "$currentVersion" ]; then currentVersion="1.0.0"; fi
             
             # Parse Major.Minor
             IFS='.' read -r vMajor vMinor vPatch <<< "$currentVersion"
             
             # Convert to German Time (CET/CEST)
             export TZ="Europe/Berlin"
             year=$(date +%Y)
             dayOfYear=$(date +%j)
             versionBuild=$(( ((year - 2000) * 400) + dayOfYear ))
             versionRevision=$(date +%H%M)
             
             # Internal version for Android (must be valid version string)
             fullVersion="$vMajor.$vMinor.$versionBuild.$versionRevision"
             
             # Readable filename for test builds
             dateStr=$(date +%Y-%m-%d_%H-%M)
             filenameVersion="$vMajor.$vMinor-dev-$dateStr"
          fi

          echo "fullVersion=$fullVersion" >> "$GITHUB_OUTPUT"
          echo "versionBuild=$versionBuild" >> "$GITHUB_OUTPUT"
          echo "filenameVersion=$filenameVersion" >> "$GITHUB_OUTPUT"

      # GEÄNDERT: Signierungsparameter hinzugefügt
      - name: Publish Android
        run: |
          dotnet publish FlashcardMobile/FlashcardMobile.Android/FlashcardMobile.Android.csproj \
          -c Release \
          -f net9.0-android \
          /p:ApplicationVersion=${{ steps.version.outputs.versionBuild }} \
          /p:ApplicationDisplayVersion="${{ steps.version.outputs.fullVersion }}" \
          /p:AndroidKeyStore=true \
          /p:AndroidSigningKeyStore=release.keystore \
          /p:AndroidSigningStorePass=${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
          /p:AndroidSigningKeyAlias=${{ secrets.ANDROID_KEYSTORE_ALIAS }} \
          /p:AndroidSigningKeyPass=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

      - name: Find APK
        id: apk
        run: |
          # APK sollte jetzt im signed Ordner oder direkt als signed markiert sein
          APK_PATH=$(find FlashcardMobile/FlashcardMobile.Android/bin/Release/net9.0-android -name "*-Signed.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
             APK_PATH=$(find FlashcardMobile/FlashcardMobile.Android/bin/Release/net9.0-android -name "*.apk" | head -n 1)
          fi
          echo "Found APK: $APK_PATH"
          echo "apkPath=$APK_PATH" >> "$GITHUB_OUTPUT"

      - name: Rename and Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ steps.version.outputs.filenameVersion }}
          path: ${{ steps.apk.outputs.apkPath }}

      # (Rest deiner Steps für Git-Commits bleiben unverändert, habe sie hier gekürzt)
      - name: Clean previous Android releases
        if: github.ref == 'refs/heads/main'
        run: |
          RELEASE_DIR="Release"
          if [ -d "$RELEASE_DIR" ]; then
            find "$RELEASE_DIR" -maxdepth 1 -type f -name "${{ env.ProjectSlug }}-android-*.apk" -delete
          fi
          rm -f "$RELEASE_DIR/.gitkeep"

      - name: Copy APK into repo Release folder
        if: github.ref == 'refs/heads/main'
        run: |
          APK_SRC="${{ steps.apk.outputs.apkPath }}"
          APK_DEST="Release/${{ env.ProjectSlug }}-android-${{ steps.version.outputs.filenameVersion }}.apk"
          mkdir -p "$(dirname "$APK_DEST")"
          cp "$APK_SRC" "$APK_DEST"

      - name: Commit Android release artifact
        if: github.ref == 'refs/heads/main'
        run: |
          branch="${GITHUB_REF_NAME}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin "$branch"
          git add Release
          if git diff --cached --quiet; then
            echo "No release changes to commit."
            exit 0
          fi
          git commit -m "Add Android APK release ${{ steps.version.outputs.filenameVersion }} [skip ci]"
          git push origin HEAD:"$branch"
