name: Build Android APK

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      Configuration: Release
      ProjectSlug: "CapyCard"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install Android workload
        run: dotnet workload install android

      # NEU: Keystore aus Secrets wiederherstellen
      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > CapyCard/CapyCard.Android/release.keystore

      - name: Calculate version
        id: version
        working-directory: CapyCard/CapyCard.Android
        run: |
          inputVersion="${{ inputs.version }}"

          if [ -n "$inputVersion" ]; then
             # Use provided version
             fullVersion="$inputVersion"
             # For versionCode, we use the run number to ensure it increases
             versionBuild=${{ github.run_number }}
             filenameVersion="$fullVersion"
          else
             # Fallback logic: Read version from project
             currentVersion=$(dotnet msbuild CapyCard.Android.csproj -nologo -getProperty:Version)
             if [ -z "$currentVersion" ]; then currentVersion="1.0.0"; fi
             
             # Parse Major.Minor
             IFS='.' read -r vMajor vMinor vPatch <<< "$currentVersion"
             
             # Convert to German Time (CET/CEST)
             export TZ="Europe/Berlin"
             year=$(date +%Y)
             dayOfYear=$(date +%j)
             versionBuild=$(( ((year - 2000) * 400) + dayOfYear ))
             versionRevision=$(date +%H%M)
             
             # Internal version for Android (must be valid version string)
             fullVersion="$vMajor.$vMinor.$versionBuild.$versionRevision"
             
             # Readable filename for test builds
             dateStr=$(date +%Y-%m-%d_%H-%M)
             filenameVersion="$vMajor.$vMinor-dev-$dateStr"
          fi

          echo "fullVersion=$fullVersion" >> "$GITHUB_OUTPUT"
          echo "versionBuild=$versionBuild" >> "$GITHUB_OUTPUT"
          echo "filenameVersion=$filenameVersion" >> "$GITHUB_OUTPUT"

      # GEÄNDERT: Signierungsparameter hinzugefügt
      - name: Publish Android
        run: |
          dotnet publish CapyCard/CapyCard.Android/CapyCard.Android.csproj \
          -c Release \
          -f net9.0-android \
          /p:ApplicationVersion=${{ steps.version.outputs.versionBuild }} \
          /p:ApplicationDisplayVersion="${{ steps.version.outputs.fullVersion }}" \
          /p:AndroidKeyStore=true \
          /p:AndroidSigningKeyStore=release.keystore \
          /p:AndroidSigningStorePass=${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
          /p:AndroidSigningKeyAlias=${{ secrets.ANDROID_KEYSTORE_ALIAS }} \
          /p:AndroidSigningKeyPass=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

      - name: Find and Rename APK
        id: apk
        run: |
          # APK sollte jetzt im signed Ordner oder direkt als signed markiert sein
          APK_PATH=$(find CapyCard/CapyCard.Android/bin/Release/net9.0-android -name "*-Signed.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
             APK_PATH=$(find CapyCard/CapyCard.Android/bin/Release/net9.0-android -name "*.apk" | head -n 1)
          fi
          
          # Rename to standard format
          NEW_NAME="CapyCard-android-${{ steps.version.outputs.filenameVersion }}.apk"
          NEW_PATH="$(dirname "$APK_PATH")/$NEW_NAME"
          mv "$APK_PATH" "$NEW_PATH"
          
          echo "Renamed APK to: $NEW_PATH"
          echo "apkPath=$NEW_PATH" >> "$GITHUB_OUTPUT"

      - name: Rename and Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.apk.outputs.apkPath }}
