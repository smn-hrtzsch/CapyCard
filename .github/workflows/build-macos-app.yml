name: Build macOS App

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      Configuration: Release
      RuntimeIdentifier: osx-arm64
      AppBundleName: "Alinas Karteikarten"
      AppBundleSlug: "Alinas-Karteikarten"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install DMG tooling
        run: |
          brew install --quiet imagemagick create-dmg

      - name: Calculate version
        id: version
        run: |
          cd FlashcardApp
          versionMajor=$(dotnet msbuild FlashcardApp.csproj -nologo -getProperty:VersionMajor)
          versionMinor=$(dotnet msbuild FlashcardApp.csproj -nologo -getProperty:VersionMinor)
          year=$(date -u +%Y)
          dayOfYear=$(date -u +%j)
          versionBuild=$(( ((year - 2000) * 400) + dayOfYear ))
          versionRevision=$(date -u +%H%M)
          msiVersion="$versionMajor.$versionMinor.$versionBuild"
          fullVersion="$msiVersion.$versionRevision"
          {
            echo "versionMajor=$versionMajor"
            echo "versionMinor=$versionMinor"
            echo "versionBuild=$versionBuild"
            echo "versionRevision=$versionRevision"
            echo "msiVersion=$msiVersion"
            echo "fullVersion=$fullVersion"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare bundle paths
        id: paths
        run: |
          publishDir="FlashcardApp/bin/${{ env.Configuration }}/net9.0/${{ env.RuntimeIdentifier }}/publish"
          appPath="$publishDir/${{ env.AppBundleName }}.app"
          dmgName="${{ env.AppBundleSlug }}-macos-${{ steps.version.outputs.fullVersion }}.dmg"
          {
            echo "publishDir=$publishDir"
            echo "appPath=$appPath"
            echo "dmgName=$dmgName"
          } >> "$GITHUB_OUTPUT"

      - name: Make build script executable
        run: chmod +x FlashcardApp/scripts/build-macos.sh

      - name: Build macOS .app bundle
        working-directory: FlashcardApp
        run: ./scripts/build-macos.sh

      - name: Remove extended attributes from bundle
        run: |
          xattr -cr "${{ steps.paths.outputs.appPath }}"

      - name: Create guided DMG image
        id: dmg
        run: |
          set -euo pipefail
          PUBLISH_DIR="${{ steps.paths.outputs.publishDir }}"
          APP_PATH="${{ steps.paths.outputs.appPath }}"
          DMG_NAME="${{ steps.paths.outputs.dmgName }}"
          DMG_PATH="$PUBLISH_DIR/$DMG_NAME"
          rm -f "$DMG_PATH"

          WORK_DIR="$(mktemp -d)"
          cp -R "$APP_PATH" "$WORK_DIR/${{ env.AppBundleName }}.app"
          ln -s /Applications "$WORK_DIR/Applications"

          BACKGROUND_DIR="$WORK_DIR/.background"
          mkdir -p "$BACKGROUND_DIR"
          BACKGROUND_IMG="$BACKGROUND_DIR/instructions.png"

          HEADER_TEXT="1. Ziehe \"${{ env.AppBundleName }}.app\" in den Ordner \"Applications\"."
          TERMINAL_TEXT="2. Oeffne das Terminal und fuehre aus:"
          APP_BUNDLE_DISPLAY="${{ env.AppBundleName }}.app"
          BACKSLASH_SPACE=$'\\ '
          ESCAPED_APP_BUNDLE=${APP_BUNDLE_DISPLAY// /$BACKSLASH_SPACE}
          DISPLAY_COMMAND_TEXT=$'xattr -cr /Applications/'"$ESCAPED_APP_BUNDLE"

          magick -size 740x450 xc:'#17171d' \
            -fill '#f5f5f7' -font 'Helvetica' -pointsize 28 -annotate +40+90 "$HEADER_TEXT" \
            -pointsize 28 -annotate +40+160 "$TERMINAL_TEXT" \
            -pointsize 22 -fill '#f0a500' -annotate +40+200 "$DISPLAY_COMMAND_TEXT" \
            -fill '#f0a500' -stroke '#f0a500' -strokewidth 8 \
            -draw 'line 290,320 500,320' \
            -draw 'line 500,320 470,300' -draw 'line 500,320 470,340' \
            "$BACKGROUND_IMG"

          create-dmg \
            --volname "${{ env.AppBundleName }}" \
            --window-pos 200 120 \
            --window-size 740 450 \
            --icon-size 85 \
            --text-size 14 \
            --background "$BACKGROUND_IMG" \
            --icon "${{ env.AppBundleName }}.app" 200 320 \
            --icon "Applications" 500 320 \
            "$DMG_PATH" "$WORK_DIR"

          rm -rf "$WORK_DIR"
          echo "dmgPath=$DMG_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload macOS app artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg-${{ steps.version.outputs.fullVersion }}
          path: ${{ steps.dmg.outputs.dmgPath }}

      - name: Clean previous macOS releases
        if: github.ref == 'refs/heads/main'
        run: |
          RELEASE_DIR="Release"
          APP_PATTERN="${{ env.AppBundleSlug }}-macos-*.app"
          DMG_PATTERN="${{ env.AppBundleSlug }}-macos-*.dmg"
          if [ -d "$RELEASE_DIR" ]; then
            find "$RELEASE_DIR" -maxdepth 1 -type d -name "$APP_PATTERN" -exec rm -rf {} +
            find "$RELEASE_DIR" -maxdepth 1 -type f -name "$DMG_PATTERN" -delete
          fi
          rm -f "$RELEASE_DIR/.gitkeep"

      - name: Copy macOS dmg into repo Release folder
        if: github.ref == 'refs/heads/main'
        run: |
          DMG_SRC="${{ steps.dmg.outputs.dmgPath }}"
          DMG_DEST="Release/${{ steps.paths.outputs.dmgName }}"
          mkdir -p "$(dirname "$DMG_DEST")"
          cp "$DMG_SRC" "$DMG_DEST"

      - name: Commit macOS release artifact
        if: github.ref == 'refs/heads/main'
        run: |
          branch="${GITHUB_REF_NAME}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin "$branch"
          git add Release
          if git diff --cached --quiet; then
            echo "No release changes to commit."
            exit 0
          fi
          git commit -m "Add macOS app release ${{ steps.version.outputs.fullVersion }} [skip ci]"
          git push origin HEAD:"$branch"
