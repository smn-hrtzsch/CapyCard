name: Build macOS App

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      Configuration: Release
      RuntimeIdentifier: osx-arm64
      AppBundleName: "CapyCard"
      AppBundleSlug: "CapyCard"
      ProjectDir: "CapyCard"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install DMG tooling
        run: |
          brew install --quiet imagemagick create-dmg

      - name: Calculate version
        id: version
        run: |
          cd CapyCard/CapyCard.Desktop

          inputVersion="${{ inputs.version }}"

          if [ -n "$inputVersion" ]; then
            IFS='.' read -r versionMajor versionMinor versionBuild <<< "$inputVersion"
            versionRevision=0
            semVersion="$versionMajor.$versionMinor.$versionBuild"
            fullVersion="$semVersion"
          else
            currentVersion=$(dotnet msbuild CapyCard.Desktop.csproj -nologo -getProperty:Version)
            if [ -z "$currentVersion" ]; then currentVersion="1.0.0"; fi
            
            IFS='.' read -r versionMajor versionMinor _ <<< "$currentVersion"
            
            # Convert to German Time (CET/CEST)
            # We use TZ environment variable for date command
            export TZ="Europe/Berlin"
            year=$(date +%Y)
            dayOfYear=$(date +%j)
            versionBuild=$(( ((year - 2000) * 400) + dayOfYear ))
            versionRevision=$(date +%H%M)
            
            semVersion="$versionMajor.$versionMinor.$versionBuild"
            
            # Readable filename for test builds
            dateStr=$(date +%Y-%m-%d_%H-%M)
            fullVersion="$versionMajor.$versionMinor-dev-$dateStr"
          fi

          {
            echo "versionMajor=$versionMajor"
            echo "versionMinor=$versionMinor"
            echo "versionBuild=$versionBuild"
            echo "versionRevision=$versionRevision"
            echo "semVersion=$semVersion"
            echo "fullVersion=$fullVersion"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare bundle paths
        id: paths
        run: |
          publishDir="CapyCard/CapyCard.Desktop/bin/${{ env.Configuration }}/net9.0/${{ env.RuntimeIdentifier }}/publish"
          appPath="$publishDir/${{ env.AppBundleName }}.app"
          dmgName="${{ env.AppBundleSlug }}-macos-${{ steps.version.outputs.fullVersion }}.dmg"
          {
            echo "publishDir=$publishDir"
            echo "appPath=$appPath"
            echo "dmgName=$dmgName"
          } >> "$GITHUB_OUTPUT"

      - name: Make build script executable
        run: chmod +x CapyCard/scripts/build-macos.sh

      - name: Build macOS .app bundle
        working-directory: CapyCard
        run: ./scripts/build-macos.sh

      - name: Remove extended attributes from bundle
        run: |
          xattr -cr "${{ steps.paths.outputs.appPath }}"

      - name: Create simple DMG image
        id: dmg
        run: |
          set -euo pipefail
          PUBLISH_DIR="${{ steps.paths.outputs.publishDir }}"
          APP_PATH="${{ steps.paths.outputs.appPath }}"
          DMG_NAME="${{ steps.paths.outputs.dmgName }}"
          DMG_PATH="$PUBLISH_DIR/$DMG_NAME"
          rm -f "$DMG_PATH"

          WORK_DIR="$(mktemp -d)"
          cp -R "$APP_PATH" "$WORK_DIR/${{ env.AppBundleName }}.app"

          APP_BUNDLE_DISPLAY="${{ env.AppBundleName }}.app"
          COMMAND_TEXT="xattr -cr /Applications/${APP_BUNDLE_DISPLAY// /\\ }"
          
          # Create a text file for copy-pasting
          echo "CapyCard Installation für macOS" > "$WORK_DIR/BITTE_LESEN.txt"
          echo "===============================" >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "" >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "Da CapyCard ein Open-Source-Projekt ist, das nicht von Apple signiert wurde," >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "muss nach der Installation ein Befehl im Terminal ausgeführt werden." >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "" >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "Schritte:" >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "1. Ziehe CapyCard in den Applications-Ordner (wie im Fenster zu sehen)." >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "2. Öffne das Programm \"Terminal\" (über Spotlight oder Programme > Dienstprogramme)." >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "3. Kopiere den folgenden Befehl und drücke Enter:" >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "" >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "$COMMAND_TEXT" >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "" >> "$WORK_DIR/BITTE_LESEN.txt"
          echo "Viel Spaß beim Lernen!" >> "$WORK_DIR/BITTE_LESEN.txt"

          # Create a background image with instructions
          BACKGROUND_DIR="$WORK_DIR/.background"
          mkdir -p "$BACKGROUND_DIR"
          BACKGROUND_IMG="$BACKGROUND_DIR/background.png"

          HINT_TEXT="1. In Applications ziehen  2. BITTE_LESEN.txt öffnen"
          
          # Create a background image with the text at the bottom
          # Using a more prominent style for the command
          magick -size 600x450 xc:white \
            -fill "#f0f0f0" -draw "rectangle 0,320 600,450" \
            -font "Helvetica-Bold" -pointsize 18 -fill "#333333" \
            -gravity North -annotate +0+340 "$HINT_TEXT" \
            -font "Menlo" -pointsize 14 -fill "#d32f2f" \
            -gravity North -annotate +0+380 "$COMMAND_TEXT" \
            "$BACKGROUND_IMG"

          create-dmg \
            --volname "${{ env.AppBundleName }}" \
            --window-pos 200 120 \
            --window-size 600 450 \
            --icon-size 100 \
            --background "$BACKGROUND_IMG" \
            --app-drop-link 450 150 \
            --icon "${{ env.AppBundleName }}.app" 150 150 \
            --icon "BITTE_LESEN.txt" 300 150 \
            --hide-extension "${{ env.AppBundleName }}.app" \
            "$DMG_PATH" "$WORK_DIR"

          rm -rf "$WORK_DIR"
          echo "dmgPath=$DMG_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload v${{ inputs.version }} "${{ steps.dmg.outputs.dmgPath }}" --clobber
