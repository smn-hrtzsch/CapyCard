name: Build macOS App

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 1.0.0)'
        required: false
        type: string
      upload_artifact:
        description: 'Upload as workflow artifact'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      upload_artifact:
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      Configuration: Release
      RuntimeIdentifier: osx-arm64
      AppBundleName: "CapyCard"
      AppBundleSlug: "CapyCard"
      ProjectDir: "CapyCard"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install DMG tooling
        run: |
          brew install --quiet imagemagick ghostscript create-dmg

      - name: Calculate version
        id: version
        run: |
          cd CapyCard/CapyCard.Desktop

          inputVersion="${{ inputs.version }}"

          if [ -n "$inputVersion" ]; then
            IFS='.' read -r versionMajor versionMinor versionBuild <<< "$inputVersion"
            versionRevision=0
            semVersion="$versionMajor.$versionMinor.$versionBuild"
            fullVersion="$semVersion"
          else
            currentVersion=$(dotnet msbuild CapyCard.Desktop.csproj -nologo -getProperty:Version)
            if [ -z "$currentVersion" ]; then currentVersion="1.0.0"; fi
            
            IFS='.' read -r versionMajor versionMinor _ <<< "$currentVersion"
            
            # Convert to German Time (CET/CEST)
            # We use TZ environment variable for date command
            export TZ="Europe/Berlin"
            year=$(date +%Y)
            dayOfYear=$(date +%j)
            versionBuild=$(( ((year - 2000) * 400) + dayOfYear ))
            versionRevision=$(date +%H%M)
            
            semVersion="$versionMajor.$versionMinor.$versionBuild"
            
            # Readable filename for test builds
            dateStr=$(date +%Y-%m-%d_%H-%M)
            fullVersion="$versionMajor.$versionMinor-dev-$dateStr"
          fi

          {
            echo "versionMajor=$versionMajor"
            echo "versionMinor=$versionMinor"
            echo "versionBuild=$versionBuild"
            echo "versionRevision=$versionRevision"
            echo "semVersion=$semVersion"
            echo "fullVersion=$fullVersion"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare bundle paths
        id: paths
        run: |
          publishDir="CapyCard/CapyCard.Desktop/bin/${{ env.Configuration }}/net9.0/${{ env.RuntimeIdentifier }}/publish"
          appPath="$publishDir/${{ env.AppBundleName }}.app"
          dmgName="${{ env.AppBundleSlug }}-macos-${{ steps.version.outputs.fullVersion }}.dmg"
          {
            echo "publishDir=$publishDir"
            echo "appPath=$appPath"
            echo "dmgName=$dmgName"
          } >> "$GITHUB_OUTPUT"

      - name: Make build script executable
        run: chmod +x CapyCard/scripts/build-macos.sh

      - name: Build macOS .app bundle
        working-directory: CapyCard
        run: ./scripts/build-macos.sh

      - name: Remove extended attributes from bundle
        run: |
          xattr -cr "${{ steps.paths.outputs.appPath }}"

      - name: Create simple DMG image
        id: dmg
        run: |
          set -euo pipefail
          PUBLISH_DIR="${{ steps.paths.outputs.publishDir }}"
          APP_PATH="${{ steps.paths.outputs.appPath }}"
          DMG_NAME="${{ steps.paths.outputs.dmgName }}"
          DMG_PATH="$PUBLISH_DIR/$DMG_NAME"
          rm -f "$DMG_PATH"

          # Prepare staging directory
          WORK_DIR="$(mktemp -d)"
          cp -R "$APP_PATH" "$WORK_DIR/${{ env.AppBundleName }}.app"
          
          APP_BUNDLE_DISPLAY="${{ env.AppBundleName }}.app"
          COMMAND_TEXT="xattr -cr /Applications/${APP_BUNDLE_DISPLAY// /\\ }"
          
          # Create a text file for copy-pasting
          echo "CapyCard Installation für macOS" > "$WORK_DIR/ANLEITUNG.txt"
          echo "===============================" >> "$WORK_DIR/ANLEITUNG.txt"
          echo "" >> "$WORK_DIR/ANLEITUNG.txt"
          echo "1. Ziehe CapyCard in den Applications-Ordner." >> "$WORK_DIR/ANLEITUNG.txt"
          echo "2. Falls die App nicht startet, öffne das Terminal." >> "$WORK_DIR/ANLEITUNG.txt"
          echo "3. Kopiere diesen Befehl und drücke Enter:" >> "$WORK_DIR/ANLEITUNG.txt"
          echo "" >> "$WORK_DIR/ANLEITUNG.txt"
          echo "$COMMAND_TEXT" >> "$WORK_DIR/ANLEITUNG.txt"
          echo "" >> "$WORK_DIR/ANLEITUNG.txt"
          echo "Viel Spaß!" >> "$WORK_DIR/ANLEITUNG.txt"

          # Create a background image
          # Logical size 600x400
          BACKGROUND_DIR="$(mktemp -d)"
          BACKGROUND_IMG="$BACKGROUND_DIR/background.png"

          magick -size 600x400 xc:white \
            -fill "#f8f9fa" -draw "rectangle 0,300 600,400" \
            -fill "#dee2e6" -stroke "#adb5bd" -strokewidth 2 \
            -draw "line 220,140 380,140" \
            -draw "path 'M 380,140 L 360,130 L 360,150 Z'" \
            -stroke none -fill "#495057" \
            -pointsize 14 -gravity North -annotate +0+320 "1. Drag CapyCard to Applications" \
            -pointsize 14 -gravity North -annotate +0+350 "2. Issues? Open ANLEITUNG.txt" \
            "$BACKGROUND_IMG"

          # create-dmg execution
          # Note: we use --icon-size 80 to fit better
          # Positions are in logical points
          create-dmg \
            --volname "CapyCard" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 80 \
            --background "$BACKGROUND_IMG" \
            --app-drop-link 480 140 \
            --icon "${{ env.AppBundleName }}.app" 120 140 \
            --icon "ANLEITUNG.txt" 300 140 \
            --hide-extension "${{ env.AppBundleName }}.app" \
            "$DMG_PATH" "$WORK_DIR"

          rm -rf "$WORK_DIR" "$BACKGROUND_DIR"
          echo "dmgPath=$DMG_PATH" >> "$GITHUB_OUTPUT"
          echo "dmgPath=$DMG_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload Artifact
        if: ${{ inputs.upload_artifact == true || inputs.upload_artifact == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.paths.outputs.dmgName }}
          path: ${{ steps.dmg.outputs.dmgPath }}
          if-no-files-found: error

      - name: Upload to Release
        if: github.event_name == 'workflow_call' || (github.event_name == 'workflow_dispatch' && github.event.inputs.version != '')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload v${{ inputs.version || github.event.inputs.version }} "${{ steps.dmg.outputs.dmgPath }}" --clobber
