name: Build macOS App

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      Configuration: Release
      RuntimeIdentifier: osx-arm64
      AppBundleName: "Alinas Karteikarten"
      AppBundleSlug: "Alinas-Karteikarten"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Calculate version
        id: version
        run: |
          cd FlashcardApp
          versionMajor=$(dotnet msbuild FlashcardApp.csproj -nologo -getProperty:VersionMajor)
          versionMinor=$(dotnet msbuild FlashcardApp.csproj -nologo -getProperty:VersionMinor)
          year=$(date -u +%Y)
          dayOfYear=$(date -u +%j)
          versionBuild=$(( ((year - 2000) * 400) + dayOfYear ))
          versionRevision=$(date -u +%H%M)
          msiVersion="$versionMajor.$versionMinor.$versionBuild"
          fullVersion="$msiVersion.$versionRevision"
          {
            echo "versionMajor=$versionMajor"
            echo "versionMinor=$versionMinor"
            echo "versionBuild=$versionBuild"
            echo "versionRevision=$versionRevision"
            echo "msiVersion=$msiVersion"
            echo "fullVersion=$fullVersion"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare bundle paths
        id: paths
        run: |
          publishDir="FlashcardApp/bin/${{ env.Configuration }}/net9.0/${{ env.RuntimeIdentifier }}/publish"
          appPath="$publishDir/${{ env.AppBundleName }}.app"
          releaseApp="Release/${{ env.AppBundleSlug }}-macos-${{ steps.version.outputs.fullVersion }}.app"
          zipName="${{ env.AppBundleSlug }}-macos-${{ steps.version.outputs.fullVersion }}.zip"
          {
            echo "publishDir=$publishDir"
            echo "appPath=$appPath"
            echo "releaseAppPath=$releaseApp"
            echo "zipName=$zipName"
          } >> "$GITHUB_OUTPUT"

      - name: Make build script executable
        run: chmod +x FlashcardApp/scripts/build-macos.sh

      - name: Build macOS .app bundle
        working-directory: FlashcardApp
        run: ./scripts/build-macos.sh

      - name: Remove extended attributes from bundle
        run: |
          xattr -cr "${{ steps.paths.outputs.appPath }}"

      - name: Package .app as zip artifact
        run: |
          PUBLISH_DIR="${{ steps.paths.outputs.publishDir }}"
          ZIP_NAME="${{ steps.paths.outputs.zipName }}"
          APP_PATH="${{ steps.paths.outputs.appPath }}"
          rm -f "$PUBLISH_DIR/$ZIP_NAME"
          /usr/bin/ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$PUBLISH_DIR/$ZIP_NAME"
          echo "packagePath=$PUBLISH_DIR/$ZIP_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload macOS app artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app-${{ steps.version.outputs.fullVersion }}
          path: FlashcardApp/bin/${{ env.Configuration }}/net9.0/${{ env.RuntimeIdentifier }}/publish/${{ steps.paths.outputs.zipName }}

      - name: Copy macOS app into repo Release folder
        if: github.ref == 'refs/heads/main'
        run: |
          APP_SRC="${{ steps.paths.outputs.appPath }}"
          APP_DEST="${{ steps.paths.outputs.releaseAppPath }}"
          mkdir -p "$(dirname "$APP_DEST")"
          rm -rf "$APP_DEST"
          /usr/bin/ditto "$APP_SRC" "$APP_DEST"
          xattr -cr "$APP_DEST"

      - name: Commit macOS release artifact
        if: github.ref == 'refs/heads/main'
        run: |
          branch="${GITHUB_REF_NAME}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin "$branch"
          git add Release
          if git diff --cached --quiet; then
            echo "No release changes to commit."
            exit 0
          fi
          git commit -m "Add macOS app release ${{ steps.version.outputs.fullVersion }} [skip ci]"
          git push origin HEAD:"$branch"
