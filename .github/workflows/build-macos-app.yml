name: Build macOS App

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      Configuration: Release
      RuntimeIdentifier: osx-arm64
      AppBundleName: "CapyCard"
      AppBundleSlug: "CapyCard"
      ProjectDir: "FlashcardMobile"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install DMG tooling
        run: |
          brew install --quiet imagemagick create-dmg

      - name: Calculate version
        id: version
        run: |
          cd FlashcardMobile/FlashcardMobile.Desktop

          inputVersion="${{ inputs.version }}"

          if [ -n "$inputVersion" ]; then
            IFS='.' read -r versionMajor versionMinor versionBuild <<< "$inputVersion"
            versionRevision=0
            semVersion="$versionMajor.$versionMinor.$versionBuild"
            fullVersion="$semVersion"
          else
            versionMajor=$(dotnet msbuild FlashcardMobile.Desktop.csproj -nologo -getProperty:VersionMajor || echo 1)
            versionMinor=$(dotnet msbuild FlashcardMobile.Desktop.csproj -nologo -getProperty:VersionMinor || echo 0)
            # Fallback if property is missing
            if [ -z "$versionMajor" ]; then versionMajor=1; fi
            if [ -z "$versionMinor" ]; then versionMinor=0; fi
            
            # Convert to German Time (CET/CEST)
            # We use TZ environment variable for date command
            export TZ="Europe/Berlin"
            year=$(date +%Y)
            dayOfYear=$(date +%j)
            versionBuild=$(( ((year - 2000) * 400) + dayOfYear ))
            versionRevision=$(date +%H%M)
            
            semVersion="$versionMajor.$versionMinor.$versionBuild"
            fullVersion="$semVersion.$versionRevision"
          fi

          {
            echo "versionMajor=$versionMajor"
            echo "versionMinor=$versionMinor"
            echo "versionBuild=$versionBuild"
            echo "versionRevision=$versionRevision"
            echo "semVersion=$semVersion"
            echo "fullVersion=$fullVersion"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare bundle paths
        id: paths
        run: |
          publishDir="FlashcardMobile/FlashcardMobile.Desktop/bin/${{ env.Configuration }}/net9.0/${{ env.RuntimeIdentifier }}/publish"
          appPath="$publishDir/${{ env.AppBundleName }}.app"
          dmgName="${{ env.AppBundleSlug }}-macos-${{ steps.version.outputs.fullVersion }}.dmg"
          {
            echo "publishDir=$publishDir"
            echo "appPath=$appPath"
            echo "dmgName=$dmgName"
          } >> "$GITHUB_OUTPUT"

      - name: Make build script executable
        run: chmod +x FlashcardMobile/scripts/build-macos.sh

      - name: Build macOS .app bundle
        working-directory: FlashcardMobile
        run: ./scripts/build-macos.sh

      - name: Remove extended attributes from bundle
        run: |
          xattr -cr "${{ steps.paths.outputs.appPath }}"

      - name: Create simple DMG image
        id: dmg
        run: |
          set -euo pipefail
          PUBLISH_DIR="${{ steps.paths.outputs.publishDir }}"
          APP_PATH="${{ steps.paths.outputs.appPath }}"
          DMG_NAME="${{ steps.paths.outputs.dmgName }}"
          DMG_PATH="$PUBLISH_DIR/$DMG_NAME"
          rm -f "$DMG_PATH"

          WORK_DIR="$(mktemp -d)"
          cp -R "$APP_PATH" "$WORK_DIR/${{ env.AppBundleName }}.app"

          # Create a background image with instructions
          BACKGROUND_DIR="$WORK_DIR/.background"
          mkdir -p "$BACKGROUND_DIR"
          BACKGROUND_IMG="$BACKGROUND_DIR/background.png"

          APP_BUNDLE_DISPLAY="${{ env.AppBundleName }}.app"
          COMMAND_TEXT="xattr -cr /Applications/${APP_BUNDLE_DISPLAY// /\\\ \\ }"
          HINT_TEXT="Nach dem Verschieben in Applications, bitte im Terminal ausfÃ¼hren:"

          # Create a background image with the text at the bottom
          magick -size 550x420 xc:none \
            -font "Helvetica" -pointsize 14 -fill "black" \
            -gravity North -annotate +0+280 "$HINT_TEXT" \
            -font "Menlo" -pointsize 12 -fill "black" \
            -gravity North -annotate +0+305 "$COMMAND_TEXT" \
            "$BACKGROUND_IMG"

          create-dmg \
            --volname "${{ env.AppBundleName }}" \
            --window-pos 200 120 \
            --window-size 550 420 \
            --icon-size 128 \
            --background "$BACKGROUND_IMG" \
            --app-drop-link 380 150 \
            --icon "${{ env.AppBundleName }}.app" 160 150 \
            --hide-extension "${{ env.AppBundleName }}.app" \
            "$DMG_PATH" "$WORK_DIR"

          rm -rf "$WORK_DIR"
          echo "dmgPath=$DMG_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload macOS app artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg-${{ steps.version.outputs.fullVersion }}
          path: ${{ steps.dmg.outputs.dmgPath }}

      - name: Clean previous macOS releases
        if: github.ref == 'refs/heads/main'
        run: |
          RELEASE_DIR="Release"
          APP_PATTERN="${{ env.AppBundleSlug }}-macos-*.dmg"
          if [ -d "$RELEASE_DIR" ]; then
            find "$RELEASE_DIR" -maxdepth 1 -type f -name "$APP_PATTERN" -delete
          fi
          # Also clean old naming convention if present
          find "$RELEASE_DIR" -maxdepth 1 -type f -name "Alinas-Karteikarten-macos-*.dmg" -delete || true

          rm -f "$RELEASE_DIR/.gitkeep"

      - name: Copy macOS dmg into repo Release folder
        if: github.ref == 'refs/heads/main'
        run: |
          DMG_SRC="${{ steps.dmg.outputs.dmgPath }}"
          DMG_DEST="Release/${{ steps.paths.outputs.dmgName }}"
          mkdir -p "$(dirname "$DMG_DEST")"
          cp "$DMG_SRC" "$DMG_DEST"

      - name: Commit macOS release artifact
        if: github.ref == 'refs/heads/main'
        run: |
          branch="${GITHUB_REF_NAME}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin "$branch"
          git add Release
          if git diff --cached --quiet; then
            echo "No release changes to commit."
            exit 0
          fi
          git commit -m "Add macOS app release ${{ steps.version.outputs.fullVersion }} [skip ci]"
          git push origin HEAD:"$branch"
