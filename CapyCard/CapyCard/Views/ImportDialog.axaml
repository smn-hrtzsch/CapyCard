<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:CapyCard.ViewModels"
             xmlns:views="clr-namespace:CapyCard.Views"
             xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="600"
             x:Class="CapyCard.Views.ImportDialog"
             x:DataType="vm:ImportViewModel">

    <!-- Import Dialog Overlay -->
    <Grid IsVisible="{Binding IsVisible}" IsHitTestVisible="{Binding IsVisible}" Background="#80000000">
        <!-- Step 1: File Selection (Visible when NO preview is shown) -->
        <views:FileSelectionDialog IsVisible="{Binding !ShowPreview}"/>

        <!-- LLM Import Overlay (Only when active) -->
        <views:LlmImportDialog IsVisible="{Binding IsLlmImportVisible}" ZIndex="10"/>

        <!-- Step 2: Import Options (Visible when preview IS shown) -->
        <Border Background="{DynamicResource SurfaceBrush}"
                CornerRadius="28"
                Padding="24"
                Margin="24"
                VerticalAlignment="Center"
                HorizontalAlignment="Stretch"
                MaxWidth="450"
                MaxHeight="800"
                IsVisible="{Binding ShowPreview}"
                BoxShadow="0 4 16 0 #40000000">
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                <StackPanel Spacing="16" HorizontalAlignment="Stretch" MinWidth="350" Margin="0,0,12,12">
                    <!-- Header -->
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="Import-Einstellungen"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   TextWrapping="Wrap"
                                   Foreground="{DynamicResource TextControlForeground}"
                                   Grid.Column="0"/>
                        <Button Command="{Binding CancelCommand}"
                                Classes="icon"
                                Grid.Column="1">
                            <materialIcons:MaterialIcon Kind="Close" Width="20" Height="20" 
                                                       Foreground="{DynamicResource TextMutedBrush}"/>
                        </Button>
                    </Grid>

                    <!-- Preview Section -->
                    <StackPanel Spacing="12">
                        <Separator Background="{DynamicResource TextMutedBrush}" Opacity="0.3"/>
                        
                        <!-- File Info -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Datei:" 
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextControlForeground}"/>
                            <TextBlock Text="{Binding PreviewFileName}"
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource TextMutedBrush}"/>
                        </StackPanel>

                        <Grid ColumnDefinitions="*,*">
                            <StackPanel Spacing="2" Grid.Column="0">
                                <TextBlock Text="{Binding PreviewCardCount}"
                                           FontWeight="SemiBold"
                                           TextWrapping="Wrap"
                                           Foreground="{DynamicResource TextControlForeground}"/>
                                <TextBlock Text="{Binding PreviewSubDeckCount}"
                                           FontSize="12"
                                           TextWrapping="Wrap"
                                           Foreground="{DynamicResource TextMutedBrush}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" HorizontalAlignment="Right">
                                <TextBlock Text="{Binding PreviewFormatName}"
                                           FontWeight="SemiBold"
                                           TextWrapping="Wrap"
                                           Foreground="{DynamicResource PrimaryBrush}"/>
                                <TextBlock Text="Mit Lernfortschritt"
                                           FontSize="12"
                                           TextWrapping="Wrap"
                                           IsVisible="{Binding PreviewHasProgress}"
                                           Foreground="{DynamicResource TextMutedBrush}"/>
                            </StackPanel>
                        </Grid>

                        <Separator Background="{DynamicResource TextMutedBrush}" Opacity="0.3"/>

                        <!-- Import Target -->
                        <TextBlock Text="Importieren als:"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextControlForeground}"/>

                        <RadioButton IsChecked="{Binding IsNewDeckSelected, Mode=TwoWay}"
                                     GroupName="ImportTarget">
                            <TextBlock Text="Neues Fach" 
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource TextControlForeground}"/>
                        </RadioButton>
                        
                        <TextBox Text="{Binding NewDeckName}"
                                 Classes="floating"
                                 Watermark="Name des neuen Fachs"
                                 IsVisible="{Binding IsNewDeckSelected}"
                                 Margin="24,0,0,0"/>

                        <RadioButton IsChecked="{Binding IsExistingDeckSelected, Mode=TwoWay}"
                                     GroupName="ImportTarget"
                                     IsEnabled="{Binding AvailableDecks.Count}">
                            <TextBlock Text="In bestehendes Fach" 
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource TextControlForeground}"/>
                        </RadioButton>

                        <ComboBox ItemsSource="{Binding AvailableDecks}"
                                  SelectedItem="{Binding SelectedExistingDeck}"
                                  IsVisible="{Binding IsExistingDeckSelected}"
                                  Margin="24,0,0,0"
                                  HorizontalAlignment="Stretch">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}" TextWrapping="Wrap"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <Separator Background="{DynamicResource TextMutedBrush}" Opacity="0.3"/>

                        <!-- Error Message in Preview -->
                        <Border Background="#40FF5252"
                                CornerRadius="8"
                                Padding="12"
                                IsVisible="{Binding HasError}">
                            <TextBlock Text="{Binding ErrorMessage}"
                                       TextWrapping="Wrap"
                                       Foreground="#FFFF5252"
                                       FontSize="12"/>
                        </Border>

                        <!-- Options -->
                        <TextBlock Text="Optionen:"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextControlForeground}"/>

                        <CheckBox IsChecked="{Binding IncludeProgress}"
                                  IsEnabled="{Binding PreviewHasProgress}">
                            <TextBlock Text="Lernfortschritt übernehmen" 
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource TextControlForeground}"/>
                        </CheckBox>

                        <StackPanel Spacing="4">
                            <TextBlock Text="Bei doppelten Karten:"
                                       FontSize="12"
                                       Foreground="{DynamicResource TextMutedBrush}"/>
                            <ComboBox SelectedIndex="{Binding DuplicateHandlingIndex}"
                                      HorizontalAlignment="Stretch">
                                <ComboBoxItem Content="Überspringen"/>
                                <ComboBoxItem Content="Ersetzen"/>
                                <ComboBoxItem Content="Beide behalten"/>
                            </ComboBox>
                        </StackPanel>
                    </StackPanel>

                    <!-- Action Buttons -->
                    <Grid ColumnDefinitions="*,*" Margin="0,8,0,0">
                        <Button Command="{Binding CancelCommand}"
                                Classes="secondary"
                                Grid.Column="0"
                                Margin="0,0,4,0"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center">
                            <TextBlock Text="Abbrechen" TextWrapping="Wrap" HorizontalAlignment="Center"/>
                        </Button>

                        <Button Command="{Binding ImportCommand}"
                                Classes="primary"
                                Grid.Column="1"
                                Margin="4,0,0,0"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                IsEnabled="{Binding ShowPreview}">
                            <TextBlock Text="Importieren" TextWrapping="Wrap" HorizontalAlignment="Center"/>
                        </Button>
                    </Grid>

                    <!-- Import Progress -->
                    <StackPanel Orientation="Horizontal"
                                Spacing="8"
                                IsVisible="{Binding IsImporting}"
                                HorizontalAlignment="Center">
                        <ProgressBar IsIndeterminate="True" Width="100"/>
                        <TextBlock Text="{Binding StatusMessage}"
                                   TextWrapping="Wrap"
                                   Foreground="{DynamicResource TextMutedBrush}"/>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>