<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:CapyCard.ViewModels"
             xmlns:behaviors="using:CapyCard.Behaviors"
             xmlns:converters="using:CapyCard.Converters"
             xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="300"
             x:Class="CapyCard.Views.SubDeckListControl"
             x:DataType="vm:DeckDetailViewModel"
             ClipToBounds="False"
             VerticalAlignment="Bottom">
    
    <!-- Use DockPanel to ensure Input and Toggle are always visible at the bottom, 
         and the List takes up remaining space (up to MaxHeight) -->
    <DockPanel VerticalAlignment="Bottom" 
               ClipToBounds="False"
               LastChildFill="True"
               MaxHeight="{Binding Bounds.Height, RelativeSource={RelativeSource AncestorType=TopLevel}}">

        <!-- INPUT FIELD - Docked Bottom (First Priority) -->
        <Border x:Name="InputContainer"
                DockPanel.Dock="Bottom"
                Background="{DynamicResource BackgroundBrush}"
                Padding="16"
                ZIndex="4">
            <Grid ColumnDefinitions="*,Auto">
                <TextBox x:Name="SubDeckTextBox" 
                         Text="{Binding NewSubDeckName}" 
                         Classes="floating"
                         Watermark="Neues Thema hinzufÃ¼gen..." 
                         Margin="0,0,12,0"
                         AcceptsReturn="False"
                         TextWrapping="NoWrap"/>
                
                <Button Command="{Binding AddSubDeckCommand}" 
                        Classes="fab"
                        Grid.Column="1">
                    <materialIcons:MaterialIcon Kind="Plus" Width="24" Height="24"/>
                </Button>
            </Grid>
        </Border>

        <!-- TOGGLE BUTTON (Floating Pill) - Docked Bottom (Second Priority, sits above Input) -->
        <Border x:Name="ToggleContainer"
                DockPanel.Dock="Bottom"
                VerticalAlignment="Bottom"
                HorizontalAlignment="Center"
                Margin="0,0,0,8"
                CornerRadius="24"
                BoxShadow="0 4 12 0 #40000000"
                ZIndex="6">
             <Button Command="{Binding ToggleSubDeckListCommand}" 
                     Padding="20,12"
                     Classes="primary subdeck-toggle"
                     CornerRadius="24">
                 <Grid ColumnDefinitions="*,Auto">
                     <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Left" VerticalAlignment="Center">
                         <TextBlock Text="Themen" FontWeight="Bold"/>
                         <Border Background="#30FFFFFF" CornerRadius="10" Padding="6,2" VerticalAlignment="Center">
                              <TextBlock Text="{Binding SubDecks.Count}" FontSize="12" FontWeight="Bold"/>
                         </Border>
                     </StackPanel>
                     
                     <Panel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                         <materialIcons:MaterialIcon Kind="ChevronDown" IsVisible="{Binding IsSubDeckListOpen}" Width="20" Height="20"/>
                         <materialIcons:MaterialIcon Kind="ChevronUp" IsVisible="{Binding !IsSubDeckListOpen}" Width="20" Height="20"/>
                     </Panel>
                 </Grid>
             </Button>
        </Border>

        <!-- LIST OVERLAY - Fills remaining space (Last Child) -->
        <!-- Note: We keep MaxHeight restriction relative to TopLevel to be safe, 
             but DockPanel logic should handle the squeeze. 
             We change VerticalAlignment to Bottom so it sits on top of the toggle button. -->
        <Border x:Name="ListOverlayContainer"
                IsVisible="{Binding IsSubDeckListOpen}" 
                Margin="20,8,20,8"
                Background="{DynamicResource BackgroundBrush}"
                BorderBrush="{DynamicResource PrimaryBrush}"
                BorderThickness="2"
                CornerRadius="{DynamicResource CornerRadiusSmall}"
                BoxShadow="0 8 32 0 #70000000"
                Padding="8"
                ZIndex="999"
                VerticalAlignment="Bottom">
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                <ItemsControl ItemsSource="{Binding SubDecks}" Grid.IsSharedSizeScope="True">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <!-- List Item -->
                        <Border Background="{DynamicResource SurfaceBrush}"
                                CornerRadius="8"
                                Margin="0,0,0,6" 
                                Padding="0">
                            <Grid>
                                <!-- VIEW MODE -->
                                <Button Command="{Binding DataContext.OpenSubDeckCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                        x:CompileBindings="False"
                                        CommandParameter="{Binding}"
                                        Classes="list-item"
                                        IsVisible="{Binding !IsEditing}"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Stretch">
                                    <Grid HorizontalAlignment="Stretch">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" SharedSizeGroup="BadgeColumn" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center" TextWrapping="Wrap" Foreground="{DynamicResource TextControlForeground}"/>
                                        
                                        <Border Grid.Column="1"
                                                Background="{DynamicResource BadgeBackgroundBrush}"
                                                Padding="8,2"
                                                CornerRadius="12"
                                                MinWidth="24"
                                                Height="24"
                                                Margin="10,0,0,0"
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Center">
                                            <TextBlock Text="{Binding CardCount}" 
                                                       FontSize="12"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"
                                                       TextAlignment="Center"
                                                       Foreground="{DynamicResource BadgeForegroundBrush}"/>
                                        </Border>

                                        <!-- Edit Action -->
                                        <Button Command="{Binding StartEditCommand}"
                                                Grid.Column="2"
                                                Classes="icon"
                                                VerticalAlignment="Center"
                                                IsVisible="{Binding !IsStatic}">
                                            <materialIcons:MaterialIcon Kind="Pencil" Width="20" Height="20" Foreground="{DynamicResource TextMutedBrush}"/>
                                        </Button>

                                        <!-- Delete Action -->
                                        <Button Command="{Binding $parent[UserControl].DataContext.DeleteSubDeckCommand}"
                                                x:CompileBindings="False"
                                                CommandParameter="{Binding}"
                                                Grid.Column="3"
                                                Classes="icon"
                                                VerticalAlignment="Center"
                                                IsVisible="{Binding !IsStatic}">
                                            <materialIcons:MaterialIcon Kind="Delete" Width="20" Height="20" Foreground="{DynamicResource TextMutedBrush}"/>
                                        </Button>
                                    </Grid>
                                </Button>

                                <!-- EDIT MODE -->
                                <Grid ColumnDefinitions="*,Auto,Auto"
                                      IsVisible="{Binding IsEditing}"
                                      Margin="8">
                                    <TextBox Text="{Binding EditText, Mode=TwoWay}"
                                             Classes="floating"
                                             VerticalAlignment="Center"
                                             Margin="0,0,8,0"
                                             Grid.Column="0"
                                             behaviors:FocusBehaviors.FocusOnTrue="{Binding IsEditing}">
                                        <TextBox.KeyBindings>
                                            <KeyBinding Command="{Binding $parent[UserControl].DataContext.SaveSubDeckEditCommand}"
                                                        CommandParameter="{Binding}"
                                                        Gesture="Enter"/>
                                            <KeyBinding Command="{Binding CancelEditCommand}"
                                                        Gesture="Escape"/>
                                        </TextBox.KeyBindings>
                                    </TextBox>

                                    <Button Command="{Binding $parent[UserControl].DataContext.SaveSubDeckEditCommand}"
                                            x:CompileBindings="False"
                                            CommandParameter="{Binding}"
                                            Classes="icon"
                                            Grid.Column="1">
                                        <materialIcons:MaterialIcon Kind="Check" Width="24" Height="24" Foreground="{DynamicResource PrimaryLightBrush}"/>
                                    </Button>

                                    <Button Command="{Binding CancelEditCommand}"
                                            Classes="icon"
                                            Grid.Column="2">
                                        <materialIcons:MaterialIcon Kind="Close" Width="24" Height="24" Foreground="{DynamicResource ErrorBrush}"/>
                                    </Button>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            </ScrollViewer>
        </Border>
    </DockPanel>
</UserControl>
