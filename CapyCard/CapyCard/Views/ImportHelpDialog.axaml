<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:CapyCard.ViewModels"
             xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="500"
             x:Class="CapyCard.Views.ImportHelpDialog"
             x:DataType="vm:ImportHelpViewModel"
             Focusable="True">

    <UserControl.KeyBindings>
        <KeyBinding Command="{Binding HandleEscapeCommand}" Gesture="Escape"/>
        <KeyBinding Command="{Binding HandleEnterCommand}" Gesture="Enter"/>
    </UserControl.KeyBindings>

    <!-- Help Dialog Overlay -->
    <Grid IsVisible="{Binding IsVisible}" IsHitTestVisible="{Binding IsVisible}" Background="#80000000" ZIndex="2000" Focusable="True">
        <Border Background="{DynamicResource SurfaceBrush}"
                CornerRadius="28"
                Padding="0"
                Margin="24"
                VerticalAlignment="Center"
                HorizontalAlignment="Stretch"
                MaxWidth="450"
                MaxHeight="850"
                BoxShadow="0 4 16 0 #40000000">
            <Panel>
                <ScrollViewer x:Name="DialogScrollViewer" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                    <Border Padding="24">
                        <StackPanel Spacing="20" 
                                    HorizontalAlignment="Center"
                                    Width="{Binding #DialogScrollViewer.Bounds.Width}"
                                    MinWidth="200"
                                    MaxWidth="380">
                            <!-- Header -->
                            <Grid ColumnDefinitions="*">
                                <TextBlock Text="Import-Möglichkeiten"
                                           FontSize="20"
                                           FontWeight="Bold"
                                           TextWrapping="Wrap"
                                           Foreground="{DynamicResource TextControlForeground}"
                                           Grid.Column="0"/>
                            </Grid>
                    <TextBlock Text="Es gibt zwei Wege, Karten in CapyCard zu importieren:"
                               TextWrapping="Wrap"
                               FontSize="14"
                               Foreground="{DynamicResource TextControlForeground}"/>
                    <StackPanel Spacing="16">
                        <!-- Option 1: File -->
                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <materialIcons:MaterialIcon Kind="FileUpload" Width="20" Height="20" 
                                                           Foreground="{DynamicResource PrimaryBrush}"/>
                                <TextBlock Text="Datei auswählen"
                                           FontWeight="Bold"
                                           Foreground="{DynamicResource TextControlForeground}"/>
                            </StackPanel>
                            <TextBlock Text="Nutze diese Option, wenn du bereits eine fertige Datei hast. Unterstützt werden .capycard, .apkg (Anki), .csv sowie .json/.txt Dateien."
                                       TextWrapping="Wrap"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextMutedBrush}"/>
                        </StackPanel>
                        <!-- Option 2: AI -->
                        <StackPanel Spacing="8">
                            <StackPanel Spacing="8">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <materialIcons:MaterialIcon Kind="AutoFix" Width="20" Height="20" 
                                                               Foreground="{DynamicResource PrimaryBrush}"/>
                                    <TextBlock Text="Via KI / Text importieren"
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource TextControlForeground}"/>
                                </StackPanel>
                                <TextBlock Text="Füge Text direkt ein (z.B. von ChatGPT). Du kannst den System-Prompt kopieren und das Ergebnis hier nutzen, ohne eine Datei speichern zu müssen."
                                           TextWrapping="Wrap"
                                           FontSize="13"
                                           Foreground="{DynamicResource TextMutedBrush}"/>
                            </StackPanel>
                            <!-- NEW: Collapsible Details (Same as FormatInfo) -->
                            <StackPanel Spacing="8">
                                <ToggleButton IsChecked="{Binding IsFormatDetailsExpanded}"
                                              Classes="icon"
                                              Width="NaN" Height="NaN"
                                              Padding="0"
                                              Background="Transparent"
                                              HorizontalAlignment="Left">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <materialIcons:MaterialIcon Kind="{Binding IsFormatDetailsExpanded, Converter={StaticResource BoolToChevronConverter}}" 
                                                                   Width="18" Height="18"
                                                                   Foreground="{DynamicResource PrimaryBrush}"/>
                                        <TextBlock Text="Format-Details (JSON) anzeigen" 
                                                   FontWeight="SemiBold"
                                                   FontSize="14"
                                                   Foreground="{DynamicResource PrimaryBrush}"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                </ToggleButton>
                                <Border IsVisible="{Binding IsFormatDetailsExpanded}"
                                        Background="{DynamicResource BackgroundBrush}" 
                                        Padding="16" 
                                        CornerRadius="16"
                                        BorderThickness="1"
                                        BorderBrush="{DynamicResource DividerBrush}"
                                        Margin="0,4,0,0">
                                    <StackPanel Spacing="12">
                                        <TextBlock Text="Struktur-Beispiel:" FontWeight="Bold" FontSize="13" Foreground="{DynamicResource TextControlForeground}"/>
                                        <Border Background="{DynamicResource SurfaceBrush}" Padding="12" CornerRadius="8">
                                            <TextBlock Text="{Binding JsonExample}" 
                                                       FontFamily="Cascadia Code,Consolas,Monospace" 
                                                       FontSize="13"
                                                       LineHeight="22"
                                                       Foreground="{DynamicResource TextControlForeground}"/>
                                        </Border>
                                        <TextBlock Text="Unterstützt hierarchische Themen und Bilder via Base64." 
                                                   FontSize="12" TextWrapping="Wrap" Foreground="{DynamicResource TextMutedBrush}"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                    <Separator Background="{DynamicResource TextMutedBrush}" Opacity="0.2"/>
                    <TextBlock Text="Tipp: Beide Optionen führen zur selben Vorschau, in der du Karten prüfen und das Ziel-Fach wählen kannst."
                               TextWrapping="Wrap"
                               FontSize="12"
                               FontStyle="Italic"
                               Foreground="{DynamicResource TextMutedBrush}"/>
                    <!-- Close Button -->
                    <Button Content="Verstanden"
                            Command="{Binding CloseCommand}"
                            Classes="primary"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            Margin="0,8,0,0"/>
                        </StackPanel>
                    </Border>
                </ScrollViewer>

                <!-- Close Button -->
                <Button Command="{Binding CloseCommand}"
                        Classes="icon"
                        VerticalAlignment="Top"
                        HorizontalAlignment="Right"
                        Margin="12">
                    <materialIcons:MaterialIcon Kind="Close" Width="20" Height="20" 
                                               Foreground="{DynamicResource TextMutedBrush}"/>
                </Button>
            </Panel>
        </Border>
    </Grid>
</UserControl>
