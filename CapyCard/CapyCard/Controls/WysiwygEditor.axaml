<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="200"
             x:Class="CapyCard.Controls.WysiwygEditor"
             x:Name="Root"
             VerticalAlignment="Stretch"
             HorizontalAlignment="Stretch">
    
    <UserControl.Resources>
        <!-- Toolbar Icons -->
        <StreamGeometry x:Key="IconBold">M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z</StreamGeometry>
        <StreamGeometry x:Key="IconItalic">M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z</StreamGeometry>
        <StreamGeometry x:Key="IconUnderline">M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z</StreamGeometry>
        <StreamGeometry x:Key="IconHighlight">M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z</StreamGeometry>
        <StreamGeometry x:Key="IconPaste">M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z</StreamGeometry>
        <StreamGeometry x:Key="IconImage">M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z</StreamGeometry>
        <StreamGeometry x:Key="IconBulletList">M4 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-6c-.83 0-1.5.67-1.5 1.5S3.17 7.5 4 7.5 5.5 6.83 5.5 6 4.83 4.5 4 4.5zm0 12c-.83 0-1.5.68-1.5 1.5s.68 1.5 1.5 1.5 1.5-.68 1.5-1.5-.67-1.5-1.5-1.5zM7 19h14v-2H7v2zm0-6h14v-2H7v2zm0-8v2h14V5H7z</StreamGeometry>
        <StreamGeometry x:Key="IconNumberList">M2 17h2v-2H3v-1h1v-1H2v1H1v1h1v2zm-1-10h3V3H1v1h2v1H1v2zm0 6h3V9H1v1h2v1H1v2zm5-8v2h14V5H6zm0 6v2h14v-2H6zm0 6v2h14v-2H6z</StreamGeometry>
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- Toolbar Button Style -->
        <Style Selector="Button.toolbar-btn">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="6"/>
            <Setter Property="Width" Value="28"/>
            <Setter Property="Height" Value="28"/>
            <Setter Property="CornerRadius" Value="4"/>
        </Style>
        <Style Selector="Button.toolbar-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SystemControlHighlightListLowBrush}"/>
        </Style>
        <Style Selector="Button.toolbar-btn:pressed /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SystemControlHighlightListMediumBrush}"/>
        </Style>
        <Style Selector="Button.toolbar-btn.active /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SystemControlHighlightAccentBrush}"/>
        </Style>
        
        <!-- Floating Toggle Button Style -->
        <Style Selector="Button.floating-btn">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{DynamicResource SurfaceBorderBrush}"/>
            <Setter Property="Padding" Value="4"/>
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Opacity" Value="0.7"/>
        </Style>
        <Style Selector="Button.floating-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SystemControlHighlightListLowBrush}"/>
            <Setter Property="Opacity" Value="1.0"/>
        </Style>
        <Style Selector="Button.floating-btn:pressed /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SystemControlHighlightListMediumBrush}"/>
        </Style>
        
        <!-- Inner TextBox - transparent background on all states -->
        <Style Selector="TextBox#EditorTextBox">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="TextBox#EditorTextBox:focus /template/ Border#PART_BorderElement">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style Selector="TextBox#EditorTextBox:pointerover /template/ Border#PART_BorderElement">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        
        <!-- Outer border focus style -->
        <Style Selector="Border#OuterBorder">
            <Setter Property="BorderBrush" Value="{DynamicResource SurfaceBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
        <Style Selector="Border#OuterBorder:focus-within">
            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
            <Setter Property="BorderThickness" Value="1.5"/>
        </Style>

        <Style Selector=".flat Border#OuterBorder">
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>

        <Style Selector=".flat Border#OuterBorder:focus-within">
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
        </Style>

        <Style Selector=".flat Border#ToolbarBorder">
            <Setter Property="CornerRadius" Value="20,20,0,0"/>
        </Style>
        
        <!-- Separator Style -->
        <Style Selector="Border.toolbar-separator">
            <Setter Property="Width" Value="1"/>
            <Setter Property="Background" Value="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"/>
            <Setter Property="Margin" Value="4,4"/>
        </Style>
    </UserControl.Styles>
    
    <Border x:Name="OuterBorder"
            BorderBrush="{DynamicResource SurfaceBorderBrush}" 
            BorderThickness="1" 
            CornerRadius="12"
            Background="{DynamicResource SurfaceBrush}">
        <Panel>
            <!-- Main Grid with Toolbar and Editor -->
            <Grid RowDefinitions="Auto,*">
                <!-- Toolbar Zeile -->
                <Border x:Name="ToolbarBorder"
                        Grid.Row="0" 
                        Background="{DynamicResource SurfaceBorderBrush}"
                        BorderBrush="{DynamicResource DividerBrush}"
                        BorderThickness="0,0,0,1"
                        CornerRadius="12,12,0,0"
                        Padding="4,4,36,4">
                    <ScrollViewer HorizontalScrollBarVisibility="Hidden" 
                                  VerticalScrollBarVisibility="Disabled">
                        <StackPanel Orientation="Horizontal" Spacing="2">
                            <!-- Fett -->
                            <Button x:Name="BoldButton"
                                    Classes="toolbar-btn" 
                                    Click="OnBoldClick"
                                    Focusable="False"
                                    ToolTip.Tip="Fett (Strg+B)">
                                <PathIcon Data="{StaticResource IconBold}" 
                                          Width="14" Height="14"/>
                            </Button>
                            
                            <!-- Kursiv -->
                            <Button x:Name="ItalicButton"
                                    Classes="toolbar-btn" 
                                    Click="OnItalicClick"
                                    Focusable="False"
                                    ToolTip.Tip="Kursiv (Strg+I)">
                                <PathIcon Data="{StaticResource IconItalic}" 
                                          Width="14" Height="14"/>
                            </Button>
                            
                            <!-- Unterstrichen -->
                            <Button x:Name="UnderlineButton"
                                    Classes="toolbar-btn" 
                                    Click="OnUnderlineClick"
                                    Focusable="False"
                                    ToolTip.Tip="Unterstrichen (Strg+U)">
                                <PathIcon Data="{StaticResource IconUnderline}" 
                                          Width="14" Height="14"/>
                            </Button>
                            
                            <!-- Hervorhebung -->
                            <Button x:Name="HighlightButton"
                                    Classes="toolbar-btn" 
                                    Click="OnHighlightClick"
                                    Focusable="False"
                                    ToolTip.Tip="Hervorheben (Strg+H)">
                                <PathIcon Data="{StaticResource IconHighlight}" 
                                          Width="14" Height="14"/>
                            </Button>
                            
                            <!-- Einfügen -->
                            <Button x:Name="PasteButton"
                                    Classes="toolbar-btn" 
                                    Click="OnPasteClick"
                                    Focusable="False"
                                    ToolTip.Tip="Einfügen">
                                <PathIcon Data="{StaticResource IconPaste}" 
                                          Width="14" Height="14"/>
                            </Button>
                            
                            <!-- Separator -->
                            <Border Classes="toolbar-separator"/>
                            
                            <!-- Bild einfügen -->
                            <Button x:Name="ImageButton"
                                    Classes="toolbar-btn" 
                                    Click="OnImageClick"
                                    Focusable="False"
                                    ToolTip.Tip="Bild einfügen">
                                <PathIcon Data="{StaticResource IconImage}" 
                                          Width="14" Height="14"/>
                            </Button>
                            
                            <!-- Separator -->
                            <Border Classes="toolbar-separator"/>
                            
                            <!-- Aufzählungsliste -->
                            <Button x:Name="BulletListButton"
                                    Classes="toolbar-btn" 
                                    Click="OnBulletListClick"
                                    Focusable="False"
                                    ToolTip.Tip="Aufzählungsliste">
                                <PathIcon Data="{StaticResource IconBulletList}" 
                                          Width="14" Height="14"/>
                            </Button>
                            
                            <!-- Nummerierte Liste -->
                            <Button x:Name="NumberListButton"
                                    Classes="toolbar-btn" 
                                    Click="OnNumberListClick"
                                    Focusable="False"
                                    ToolTip.Tip="Nummerierte Liste">
                                <PathIcon Data="{StaticResource IconNumberList}" 
                                          Width="14" Height="14"/>
                            </Button>

                            <!-- Separator -->
                            <Border Classes="toolbar-separator"/>

                            <!-- Checkliste -->
                            <Button x:Name="ChecklistButton"
                                    Classes="toolbar-btn"
                                    Click="OnChecklistClick"
                                    Focusable="False"
                                    ToolTip.Tip="Checkliste einfügen">
                                <materialIcons:MaterialIcon Kind="CheckboxMarkedOutline"
                                                            Width="14"
                                                            Height="14"/>
                            </Button>

                            <!-- Zitat -->
                            <Button x:Name="QuoteButton"
                                    Classes="toolbar-btn"
                                    Click="OnQuoteClick"
                                    Focusable="False"
                                    ToolTip.Tip="Zitat einfügen">
                                <materialIcons:MaterialIcon Kind="FormatQuoteOpen"
                                                            Width="14"
                                                            Height="14"/>
                            </Button>

                            <!-- Tabelle -->
                            <Button x:Name="TableButton"
                                    Classes="toolbar-btn"
                                    Click="OnTableClick"
                                    Focusable="False"
                                    ToolTip.Tip="Tabelle einfügen">
                                <materialIcons:MaterialIcon Kind="Table"
                                                            Width="14"
                                                            Height="14"/>
                            </Button>

                            <!-- Formel -->
                            <Button x:Name="FormulaButton"
                                    Classes="toolbar-btn"
                                    Click="OnFormulaClick"
                                    Focusable="False"
                                    ToolTip.Tip="Formel einfügen">
                                <materialIcons:MaterialIcon Kind="FunctionVariant"
                                                            Width="14"
                                                            Height="14"/>
                            </Button>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
                
                <!-- Editor Area - Flexibel mit MinHeight, wächst mit verfügbarem Platz -->
                <!-- Ein gemeinsamer ScrollViewer für beide Modi damit sie gleich groß sind -->
                <ScrollViewer Grid.Row="1" 
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled"
                              x:Name="EditorScrollViewer">
                    <Grid MinHeight="80">
                        <!-- Live formatierte Anzeige (sichtbar wenn NICHT editiert wird) -->
                        <TextBlock x:Name="FormattedDisplay"
                                   TextWrapping="Wrap"
                                   VerticalAlignment="Top"
                                   Margin="14,12,14,12"
                                   IsHitTestVisible="False"
                                   IsVisible="False"/>
                        
                        <!-- Watermark (nur sichtbar wenn leer und nicht fokussiert) -->
                        <TextBlock x:Name="WatermarkDisplay"
                                   Text="{Binding Watermark, ElementName=Root}"
                                   TextWrapping="Wrap"
                                   VerticalAlignment="Top"
                                   Margin="14,12,14,12"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                   Opacity="0.6"
                                   IsHitTestVisible="False"
                                   IsVisible="True"/>
                        
                         <!-- TextBox für Eingabe - immer vorhanden, Text-Farbe wechselt -->
                         <TextBox x:Name="EditorTextBox"
                                  AcceptsReturn="True"
                                  TextWrapping="Wrap"
                                  Background="Transparent"
                                  BorderThickness="0"
                                  Padding="12,10,12,10"
                                  Margin="0"
                                  VerticalAlignment="Stretch"
                                  HorizontalAlignment="Stretch"
                                  KeyDown="OnEditorKeyDown"
                                  TextChanged="OnTextChanged"
                                  GotFocus="OnEditorGotFocus"
                                  LostFocus="OnEditorLostFocus"/>

                        <!-- Overlay fuer Rechtschreib-Unterstreichungen im Edit-Modus -->
                        <TextBlock x:Name="SpellcheckOverlay"
                                   TextWrapping="Wrap"
                                   VerticalAlignment="Top"
                                   Margin="{Binding Padding, ElementName=EditorTextBox}"
                                   Foreground="Transparent"
                                   IsHitTestVisible="False"
                                   IsVisible="False"
                                   ZIndex="5"
                                   FontFamily="{Binding FontFamily, ElementName=EditorTextBox}"
                                   FontSize="{Binding FontSize, ElementName=EditorTextBox}"
                                   FontStyle="{Binding FontStyle, ElementName=EditorTextBox}"
                                   FontWeight="{Binding FontWeight, ElementName=EditorTextBox}"/>
                     </Grid>
                 </ScrollViewer>
            </Grid>
            
            <!-- Floating Toggle Button (outside the Grid, always visible) -->
            <Button x:Name="ToggleToolbarButton"
                    Classes="floating-btn" 
                    Click="OnToggleToolbarClick"
                    Focusable="False"
                    ToolTip.Tip="Toolbar ausblenden"
                    ZIndex="100"
                    VerticalAlignment="Top"
                    HorizontalAlignment="Right"
                    Margin="0,4,4,0">
                <materialIcons:MaterialIcon x:Name="ToggleToolbarIcon"
                                             Kind="EyeOff" 
                                             Width="12" 
                                             Height="12"/>
            </Button>
        </Panel>
    </Border>
</UserControl>
